"use strict";(self.webpackChunktasky_tasker=self.webpackChunktasky_tasker||[]).push([[993],{7993:(P,m,n)=>{n.r(m),n.d(m,{PollModule:()=>se});var h=n(6895),i=n(9132),c=n(5861),C=n(6599);class b extends Error{constructor(){super("Request was cancelled"),this.name="CancelError"}get isCanceled(){return!0}}class E extends Error{constructor(v){super("Could not get the public IP address",v),this.name="IpNotFoundError"}}const x={timeout:5e3},u={v4:["https://ipv4.icanhazip.com/","https://api.ipify.org/"],v6:["https://ipv6.icanhazip.com/","https://api6.ipify.org/"]},O=(s,v,e)=>{const o=new XMLHttpRequest;let l;const a=new Promise((d,r)=>{l=r,o.addEventListener("error",r,{once:!0}),o.addEventListener("timeout",r,{once:!0}),o.addEventListener("load",()=>{const p=o.responseText.trim();p&&C[e](p)?d(p):r()},{once:!0}),o.open("GET",s),o.timeout=v.timeout,o.send()});return a.cancel=()=>{o.abort(),l(new b)},a},w=(s,v)=>{let e;const o=(0,c.Z)(function*(){const l=[...u[s],...v.fallbackUrls??[]];let a;for(const d of l)try{return e=O(d,v,s),yield e}catch(r){if(a=r,r instanceof b)throw r}throw new E({cause:a})})();return o.cancel=()=>{e.cancel()},o},F={v4:s=>w("v4",{...x,...s}),v6:s=>w("v6",{...x,...s})};function L(){return(L=(0,c.Z)(function*(s){if(s={timeout:5e3,ipVersion:4,...s},!navigator?.onLine)return!1;const v=4===s.ipVersion?"v4":"v6";try{return yield F[v](s),!0}catch{return!1}})).apply(this,arguments)}var t=n(4650),M=n(8826),T=n(7009),N=n(5475),y=n(5412),_=n(4859),R=n(7392),Z=n(4006),k=n(9549),U=n(4144),A=n(4633);function B(s,v){if(1&s){const e=t.EpF();t.TgZ(0,"div",10)(1,"mat-form-field",10)(2,"mat-label"),t._uU(3,"Filtro"),t.qZA(),t.TgZ(4,"input",11),t.NdJ("ngModelChange",function(l){t.CHM(e);const a=t.oxw();return t.KtG(a.filtertext=l)}),t.qZA(),t.TgZ(5,"mat-icon",12),t._uU(6,"search"),t.qZA()()()}if(2&s){const e=t.oxw();t.xp6(4),t.Q6J("ngModel",e.filtertext)}}function I(s,v){if(1&s&&(t.TgZ(0,"mat-list-option",13),t._uU(1),t.qZA()),2&s){const e=v.$implicit;t.Q6J("value",e),t.xp6(1),t.hij(" ",e.name," ")}}function Y(s,v){if(1&s){const e=t.EpF();t.TgZ(0,"div",14)(1,"button",8),t.NdJ("click",function(){t.CHM(e);const l=t.oxw();return t.KtG(l.onNew())}),t._uU(2," Nuevo\xa0 "),t.TgZ(3,"mat-icon"),t._uU(4,"add"),t.qZA()()()}}let z=(()=>{class s{constructor(e,o){this.dialogRef=e,this.data=o,this.valuelst=[],this.filtertext="",this.selectedOptions=[],e.disableClose=!0}onNew(){this.dialogRef.close({new:!0})}ngOnInit(){this.valuelst=this.data.valuelst}onFilter(e){const o=this.filtertext.toUpperCase();return!!(0===o.length||e&&e.name&&e.name.toUpperCase().search(o)>=0)}onSave(){this.dialogRef.close(this.selectedOptions)}onDismiss(){this.dialogRef.close()}static#e=this.\u0275fac=function(o){return new(o||s)(t.Y36(y.so),t.Y36(y.WI))};static#t=this.\u0275cmp=t.Xpm({type:s,selectors:[["app-select-dialog"]],decls:17,vars:6,consts:[[1,"flex","flex-col","h-full"],[1,"h-20","p-3","text-9xl","bg-violet-600","text-white"],["style","width: 100%;",4,"ngIf"],[1,"flex-1","overflow-auto"],[3,"ngModel","ngModelChange"],[3,"value",4,"ngFor","ngForOf"],[1,"flex","p-3","justify-end","border-t","border-violet-500"],["class","flex-1","fxFlex","",4,"ngIf"],["mat-stroked-button","","color","warn",3,"click"],["mat-stroked-button","","color","primary","cdkFocusInitia","",3,"click"],[2,"width","100%"],["matInput","",3,"ngModel","ngModelChange"],["matSuffix",""],[3,"value"],["fxFlex","",1,"flex-1"]],template:function(o,l){1&o&&(t.TgZ(0,"div",0)(1,"h1",1),t._uU(2),t.qZA(),t.TgZ(3,"p"),t._uU(4),t.qZA(),t.YNc(5,B,7,1,"div",2),t.TgZ(6,"div",3)(7,"mat-selection-list",4),t.NdJ("ngModelChange",function(d){return l.selectedOptions=d}),t.YNc(8,I,2,2,"mat-list-option",5),t.qZA()(),t.TgZ(9,"div",6),t.YNc(10,Y,5,0,"div",7),t.TgZ(11,"button",8),t.NdJ("click",function(){return l.onDismiss()}),t.TgZ(12,"mat-icon"),t._uU(13,"close"),t.qZA()(),t.TgZ(14,"button",9),t.NdJ("click",function(){return l.onSave()}),t.TgZ(15,"mat-icon"),t._uU(16,"done"),t.qZA()()()()),2&o&&(t.xp6(2),t.Oqu(l.data.title),t.xp6(2),t.Oqu(l.data.description),t.xp6(1),t.Q6J("ngIf",l.data.viewfilter),t.xp6(2),t.Q6J("ngModel",l.selectedOptions),t.xp6(1),t.Q6J("ngForOf",l.valuelst),t.xp6(2),t.Q6J("ngIf",l.data.viewAdd))},dependencies:[h.sg,h.O5,_.lW,R.Hw,Z.Fj,Z.JJ,Z.On,k.KE,k.hX,k.R9,U.Nt,A.Ub,A.vS]})}return s})(),G=(()=>{class s{constructor(e){this.dialog=e}aSelectDefault(e){let o=window.innerHeight-20;e.dgheigth=e.dgheigth||o,o=o>e.dgheigth?e.dgheigth:o;let l=window.innerWidth-20;return e.dgwidth=e.dgwidth||l,l=l>e.dgwidth?e.dgwidth:l,this.dialogRef=this.dialog.open(z,{panelClass:"custom-dialog-container",height:o.toString()+"px",width:l.toString()+"px",data:e}),this.dialogRef.afterClosed()}static#e=this.\u0275fac=function(o){return new(o||s)(t.LFG(y.uw))};static#t=this.\u0275prov=t.Yz7({token:s,factory:s.\u0275fac,providedIn:"root"})}return s})();var Q=n(2419),j=n(5377),H=n(1316),X=n(3646),K=n(2395);function W(s,v){if(1&s){const e=t.EpF();t.TgZ(0,"button",6),t.NdJ("click",function(){t.CHM(e);const l=t.oxw();return t.KtG(l.onBack())}),t.TgZ(1,"mat-icon"),t._uU(2,"arrow_back"),t.qZA()()}}function q(s,v){if(1&s){const e=t.EpF();t.TgZ(0,"button",6),t.NdJ("click",function(){t.CHM(e);const l=t.oxw();return t.KtG(l.onEndPoll())}),t._uU(1," Finalizar"),t.TgZ(2,"mat-icon"),t._uU(3,"done"),t.qZA()()}}const V=[{path:"",component:(()=>{class s{constructor(e,o,l,a,d,r,p){this.dtb=e,this.snkBar=o,this.dg=l,this.ds=a,this.nvg=d,this.sharedvar=r,this.notifServ=p,this.lchat=!1,this.goto=[]}ngOnInit(){var e=this;return(0,c.Z)(function*(){e.sharedvar.pollExecSelected.pollList.length>0?(e.selectedPoll=e.sharedvar.pollExecSelected.pollList[0],e.goto.push(e.selectedPoll.id)):(e.snkBar.open("Listado de actividades vac\xedo.","Ok",{duration:5e3}),e.nvg.onRouteBack());const o=e.dtb.getLocalPollResult(e.sharedvar.pollExecSelected.pollResult_id).subscribe(l=>{o&&o.unsubscribe(),e.sharedvar.selPollResult=JSON.parse(JSON.stringify(l)),e.sharedvar.selPollResult.status<2&&e.OnStartPoll(),e.subscribeChatEvent(),e.sharedvar.pollExecSelected.done&&e.onEndPoll()})})()}OnStartPoll(){var e=this;return(0,c.Z)(function*(){e.sharedvar.selPollResult.status=2,e.sharedvar.selPollResult.date_ini=Number(Date.now()),e.sharedvar.pollExecSelected.onStart&&e.sharedvar.pollExecSelected.onStart.geoLoc&&(e.sharedvar.selPollResult.geoLocStart=yield e.getLocalization()),e.dtb.addUpdateLocalList(e.sharedvar.pollExecSelected,e.sharedvar.selPollResult),e.dtb.updatePartialAsync(e.sharedvar.selPollResult,"status")})()}OnEndPoll(){var e=this;return(0,c.Z)(function*(){e.sharedvar.selPollResult.date_end=Number(Date.now()),e.sharedvar.selPollResult.staff_picture="",e.sharedvar.pollExecSelected.onEnd&&e.sharedvar.pollExecSelected.onEnd.geoLoc&&(e.sharedvar.selPollResult.geoLocEnd=yield e.getLocalization())})()}subscribeChatEvent(){var o,e=this;this.chatSub=this.notifServ.dtb_notification().subscribe({next:(o=(0,c.Z)(function*(l){"chat"===l.collection&&l.field_id&&l.field_id===e.sharedvar.selPollResult._id&&e.getChatState()}),function(a){return o.apply(this,arguments)}),complete:()=>{console.log()}}),this.getChatState()}getChatState(){var e=this;return(0,c.Z)(function*(){const o=yield e.dtb.getChat(e.sharedvar.selPollResult._id);e.sharedvar.selPollResult.status_date=Date.now(),e.sharedvar.selPollResult.chats=o;const l=o.length-1;return l>=0&&"W"===o[l].type?(e.snkBar.open(`Mensaje: ${e.sharedvar.selPollResult.chats[l].msg}.`,"Ok",{duration:3e3}),e.lchat=!0):e.lchat=!1,l})()}ngOnDestroy(){this.subs&&this.subs.unsubscribe()}getClicked(e){3===e.index&&this.dg.aChat({title:"Chat",dgwidth:400,value:this.sharedvar.selPollResult})}onGetData(e){var o=this;return(0,c.Z)(function*(){const l=e._btnclick_;if(l&&o.selectedPoll.schema.controls){const a=o.selectedPoll.schema.controls.find(d=>d.name===l);if(a&&a.tags)switch(a.tags.type){case"goto":const d=o.sharedvar.pollExecSelected.pollList.find(r=>r.id===a.avalue);if(d&&a.avalue&&a.avalue.length>0)return o.goto.push(a.avalue),o.updateLocalList(o.selectedPoll.values,e),void(o.selectedPoll=d);break;case"geolocation":e[l]=yield o.getLocalization(),a.sideBtn="done";break;case"picture":o.getPicture(e,a,l);break;case"draw":o.getDraw(e,a,l);break;case"appoint":o.getAppoint(e,l);break;case"costumer":o.getCostumer(e,l);break;case"product":o.getProduct(e,l)}}o.updateLocalList(o.selectedPoll.values,e)})()}getLocalization(){var e=this;return(0,c.Z)(function*(){const l=yield e.getPosition();l.lng=Math.trunc(1e4*l.lng)/1e4,l.lat=Math.trunc(1e4*l.lat)/1e4;const a=`${l.lat},${l.lng}`;return e.snkBar.open("Ubicaci\xf3n ingresada.","Ok",{duration:3e3}),e.dtb.getLink2geo(a)})()}updateLocalList(e,o){o._btnEvent_="",o._btnclick_="",this.dg.updatePropResult(e,o),this.dtb.addUpdateLocalList(this.sharedvar.pollExecSelected,this.sharedvar.selPollResult)}updateValues2Save(e,o){o._btnEvent_="",o._btnclick_="",this.dg.updatePropResult(e,o)}onBack(){if(this.selectedPoll.values&&!1===this.selectedPoll.values._valid_)this.snkBar.open("Debe llenar los campos requeridos.","Ok",{duration:3e3});else if(this.goto.length>1){const e=this.sharedvar.pollExecSelected.pollList.find(o=>o.id===this.goto[this.goto.length-2]);e&&(this.selectedPoll=e,this.goto.splice(this.goto.length-1,1))}}onEndPoll(){var e=this;return(0,c.Z)(function*(){e.selectedPoll.values&&!1===e.selectedPoll.values._valid_?e.snkBar.open("Debe llenar los campos requeridos.","Ok",{duration:3e3}):e.selectedPoll.allowEnd&&e.snkBar.open("\xbfFinalizar?","Ok",{duration:5e3}).onAction().subscribe((0,c.Z)(function*(){e.sharedvar.selPollResult=e.onResultDone(e.sharedvar.selPollResult),e.sharedvar.selPollResult?(e.sharedvar.selPollResult.ended=!0,e.sharedvar.selPollResult.status=3,e.sharedvar.selPollResult.status_date=Date.now(),(yield function J(s){return L.apply(this,arguments)}())?e.dtb.promisePictList(e.sharedvar.pollExecSelected,e.sharedvar.selPollResult).then(function(){var o=(0,c.Z)(function*(l){l&&(e.sharedvar.pollExecSelected.pollList.forEach(a=>{e.updateValues2Save(e.sharedvar.selPollResult.values,a.values)}),yield e.OnEndPoll(),e.sharedvar.selPollResult=yield e.dtb.CreateUpdatePollResult(e.sharedvar.selPollResult),console.log(e.sharedvar.selPollResult),e.dtb.delFromLocalList(e.sharedvar.pollExecSelected),e.snkBar.open('Encuesta finalizada. Siga el reporte de sus encuestas en "Estado de mi Cuenta".',"Ok",{duration:5e3}))});return function(l){return o.apply(this,arguments)}}()):(e.snkBar.open("No fue posible exportar la informaci\xf3n. Por favor sincronice cuando est\xe9 linea.","Ok",{duration:3e3}),e.sharedvar.pollExecSelected.done=!0,e.dtb.addUpdateLocalList(e.sharedvar.pollExecSelected,e.sharedvar.selPollResult)),e.nvg.onRouteBack()):e.snkBar.open("Existen campos sin llenar.","Ok",{duration:3e3})}))})()}geoloc(){var e=this;return(0,c.Z)(function*(){yield e.getPosition().then(l=>{l.lng=Math.trunc(100*l.lng)/100,l.lat=Math.trunc(100*l.lat)/100})})()}getPosition(){return new Promise((e,o)=>{navigator.geolocation.getCurrentPosition(l=>{e({lng:l.coords.longitude,lat:l.coords.latitude})},l=>{o(l)})})}getPicture(e,o,l){this.dg.aCamera({title:"C\xe1mara",value:{img:e,name:"pepito"}}).subscribe(r=>{r&&r.urlrute&&r.urlrute.length>0&&(e[l]=r.urlrute,this.updateLocalList(this.selectedPoll.values,e))})}getDraw(e,o,l){this.dg.aDraw({title:"Dibujar",value:{img:e[l]?e[l]:o.avalue,name:"pepito"}}).subscribe(r=>{r&&r.urlrute&&r.urlrute.length>0&&(e[l]=r.urlrute,this.updateLocalList(this.selectedPoll.values,e))})}getAppoint(e,o){var l=this;return(0,c.Z)(function*(){const a=[];(!l.sharedvar.pollGrpAppointList||0===l.sharedvar.pollGrpAppointList.length)&&(yield l.dtb.getExportedPollGroup2SelAsync()),l.sharedvar.pollGrpAppointList.forEach(p=>{const g=p.split(":");a.push({key:g[1],value:g[0]})}),l.dg.aDefault({title:"Agendar",schema:{controls:[{name:"pollgrp",label:"Actividad:",type:"select",style:"w-full",validators:{required:!0},selectOptions:a},{name:"datetime",label:"Fecha y hora:",type:"datetime-local",default:100,validators:{required:!0}}]},value:l.sharedvar.availableFilter,dgwidth:400,dgheigth:325}).subscribe(p=>{if(p&&p.pollgrp&&p.pollgrp.length>0&&p.datetime&&p.datetime.length>0){let g=a.findIndex(ae=>ae.key===p.pollgrp);const f=a[g].value;e[o]=`${f}: ${p.datetime}`,l.updateLocalList(l.selectedPoll.values,e);const D=`--${p.pollgrp}|${l.sharedvar.selPollResult._id}|${o}`;for(l.sharedvar.staff.appoint||(l.sharedvar.staff.appoint=[]),g=0;g<l.sharedvar.staff.appoint.length;g++)if(l.sharedvar.staff.appoint[g].includes(D)){l.sharedvar.staff.appoint.splice(g,1);break}l.sharedvar.staff.appoint.push(`${f}|${p.datetime}${D}`),l.dtb.setStaff(l.sharedvar.staff)}})})()}getCostumer(e,o){const l=this.sharedvar.pollExecSelected.costumerList;l&&l.length>0&&this.onSelCtrlStaff(l,"Seleccione Clientes",e,o,"costumer")}getProduct(e,o){const l=this.sharedvar.pollExecSelected.productList;l&&l.length>0&&this.onSelCtrlStaff(l,"Seleccione Clientes",e,o,"product")}onSelCtrlStaff(e,o,l,a,d){var r=this;return(0,c.Z)(function*(){const p=[];e.forEach(f=>{if(f){const $=f.split(":");p.push({selected:!1,myid:$[0],name:$[1]})}});const g={title:o,dgwidth:300,viewfilter:!0,viewAdd:!1,valuelst:p};return yield r.ds.aSelectDefault(g).subscribe(f=>{f&&(l[a]=`${f[0].myid}:${f[0].name}`,r.updateLocalList(r.selectedPoll.values,l),r.sharedvar.selPollResult.crm[d]=l[a])})})()}onResultDone(e){let o={...e};return this.sharedvar.pollExecSelected.pollList.forEach(l=>{o.values={...o.values,...l.values}}),o.values&&(o.values._btnEvent_="",o.values._valid_=!0),o}static#e=this.\u0275fac=function(o){return new(o||s)(t.Y36(M.k),t.Y36(T.ux),t.Y36(N.x),t.Y36(G),t.Y36(Q.$),t.Y36(j.D),t.Y36(H.$))};static#t=this.\u0275cmp=t.Xpm({type:s,selectors:[["app-poll"]],decls:8,vars:6,consts:[[1,"flex","flex-col","h-screen","w-screen"],[3,"buttons","lchat","onClicked"],[1,"grow","px-3","pt-3","overflow-auto"],[3,"jsonFormData","values","result"],[1,"h-12","flex","flex-row","items-center","justify-center","border-t","border-violet-500"],["color","primary","mat-raised-button","",3,"click",4,"ngIf"],["color","primary","mat-raised-button","",3,"click"]],template:function(o,l){1&o&&(t.TgZ(0,"div",0)(1,"app-header",1),t.NdJ("onClicked",function(d){return l.getClicked(d)}),t.qZA(),t.TgZ(2,"div",2)(3,"app-dynamic-form",3),t.NdJ("result",function(d){return l.onGetData(d)}),t.qZA()(),t.TgZ(4,"div",4),t.YNc(5,W,3,0,"button",5),t._uU(6," \xa0 "),t.YNc(7,q,4,0,"button",5),t.qZA()()),2&o&&(t.xp6(1),t.Q6J("buttons","000100")("lchat",l.lchat),t.xp6(2),t.Q6J("jsonFormData",l.selectedPoll.schema)("values",l.selectedPoll.values),t.xp6(2),t.Q6J("ngIf",l.goto.length>1),t.xp6(2),t.Q6J("ngIf",l.selectedPoll.allowEnd))},dependencies:[h.O5,X.G,K.r,_.lW,R.Hw]})}return s})()}];let ee=(()=>{class s{static#e=this.\u0275fac=function(o){return new(o||s)};static#t=this.\u0275mod=t.oAB({type:s});static#l=this.\u0275inj=t.cJS({imports:[i.Bz.forChild(V),i.Bz]})}return s})();var te=n(8471),le=n(6842),oe=n(8255);let se=(()=>{class s{static#e=this.\u0275fac=function(o){return new(o||s)};static#t=this.\u0275mod=t.oAB({type:s});static#l=this.\u0275inj=t.cJS({imports:[h.ez,ee,te.O,le.N,oe.Tx,_.ot,R.Ps,T.ZX]})}return s})()},4066:P=>{const m="[a-fA-F\\d:]",n=u=>u&&u.includeBoundaries?`(?:(?<=\\s|^)(?=${m})|(?<=${m})(?=\\s|$))`:"",h="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",i="[a-fA-F\\d]{1,4}",c=`\n(?:\n(?:${i}:){7}(?:${i}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8\n(?:${i}:){6}(?:${h}|:${i}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4\n(?:${i}:){5}(?::${h}|(?::${i}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4\n(?:${i}:){4}(?:(?::${i}){0,1}:${h}|(?::${i}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4\n(?:${i}:){3}(?:(?::${i}){0,2}:${h}|(?::${i}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4\n(?:${i}:){2}(?:(?::${i}){0,3}:${h}|(?::${i}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4\n(?:${i}:){1}(?:(?::${i}){0,4}:${h}|(?::${i}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4\n(?::(?:(?::${i}){0,5}:${h}|(?::${i}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4\n)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1\n`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),C=new RegExp(`(?:^${h}$)|(?:^${c}$)`),b=new RegExp(`^${h}$`),E=new RegExp(`^${c}$`),x=u=>u&&u.exact?C:new RegExp(`(?:${n(u)}${h}${n(u)})|(?:${n(u)}${c}${n(u)})`,"g");x.v4=u=>u&&u.exact?b:new RegExp(`${n(u)}${h}${n(u)}`,"g"),x.v6=u=>u&&u.exact?E:new RegExp(`${n(u)}${c}${n(u)}`,"g"),P.exports=x},6599:(P,m,n)=>{const h=n(4066),i=c=>h({exact:!0}).test(c);i.v4=c=>h.v4({exact:!0}).test(c),i.v6=c=>h.v6({exact:!0}).test(c),i.version=c=>i(c)?i.v4(c)?4:6:void 0,P.exports=i}}]);